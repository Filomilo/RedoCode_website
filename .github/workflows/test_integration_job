name: integration test

on: push

jobs:
    docker_structure_test:
        defaults:
            run:
            working-directory: ./ProjectSource
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v2

            - name: install docker
              run: |
                sudo apt-get update
                sudo apt-get install ca-certificates curl
                sudo install -m 0755 -d /etc/apt/keyrings
                sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
                sudo chmod a+r /etc/apt/keyrings/docker.asc

                echo \
                    "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu \
                    $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | \
                    sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
                sudo apt-get update
                sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin -y
                    
            - name: start containers
              run: |
                docker compose up -d
                docker ps

            - name: Set up Node.js
              working-directory: ./ProjectSource/RedoCode_frontend
              uses: actions/setup-node@v3
              with:
                node-version: 20

            - name: install node dependecies
              working-directory: ./ProjectSource/RedoCode_frontend
              run: |
                    apt-get update
                    apt-get install libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2 libxtst6 xauth xvfb -y
                    npm install cypress
                    npm install

            
            - name: run test
              working-directory: ./ProjectSource/RedoCode_frontend
              run: |
                curl localhost
                curl http://localhost:9090/exercises
                ls
                npm run test:prod:e2e
